<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>XAKKT 2.0</title>
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
</head>

<body class="hold-transition sidebar-mini sidebar-collapse">
  <div class="wrapper">
    <!-- Navbar -->
    <%- await include('../../_partials/_admin/navbar.ejs'); %>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <%- await include('../../_partials/_admin/sidebar.ejs'); %>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
          <!-- Content Header (Page header) -->
          <section class="content-header">
            <div class="container-fluid">
              <div class="row mb-2">
                <div class="col-sm-6">
                  <h1>Orders</h1>
                </div>
                <div class="col-sm-6">
                  <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Orders</li>
                  </ol>
                </div>
              </div>
            </div><!-- /.container-fluid -->
          </section>
          <!--- message section should be common for all-->

          <% if(failure.length){ %>
            <div class="alert alert-danger">
              <strong>
                <%= failure[0] %>
              </strong>
            </div>
            <% } %>
              <% if(success.length){ %>
                <div class="alert alert-success">
                  <strong>
                    <%= success %>
                  </strong>
                </div>
                <% } %>

                  <!---- end of messages -->
                  <!-- Main content -->
                  <section class="content">
                    <div class="container-fluid">
                      <div class="row">
                        <div class="col-12">

                          <!-- /.card -->

                          <div class="card">
                            <!-- <div class="card-header">
                  <h3 class="card-title">All Brand</h3>
                </div> -->
                            <!-- /.card-header -->
                            <div class="card-body">
                              <table id="order" class="table table-bordered table-striped">
                                <thead>
                                  <tr>
                                    <th>Order Id</th>
                                    <th>Customer Name</th>
                                    <th>Cutomer Address</th>
                                    <th>Store Name</th>
                                    <th>Order Placed On</th>
                                    <!--th>Order Delivered On</th-->
                                    <th>Order Status</th>
                                    <!--th>Payment Method</th-->
                                    <th>Total Payment</th>
                                    <th>Delevery Feedback</th>
                                    <!--th>Feedback Comment</th-->
                                    <th>Action</th>
                                  </tr>
                                </thead>
                                <tbody>
                                </tbody>
                                <tfoot>
                                  <tr>
                                    <th>Order Id</th>
                                    <th>Customer Name</th>
                                    <th>Cutomer Address</th>
                                    <th>Store Name</th>
                                    <th>Order Placed On</th>
                                    <!--th>Order Delivered On</th-->
                                    <th>Order Status</th>
                                    <!--th>Payment Method</th-->
                                    <th>Total Payment</th>
                                    <th>Delevery Feedback</th>
                                    <!--th>Feedback Comment</th-->
                                    <th>Action</th>
                                  </tr>
                                </tfoot>
                              </table>
                            </div>
                            <!-- /.card-body -->
                          </div>
                          <!-- /.card -->
                        </div>
                        <!-- /.col -->
                      </div>
                      <!-- /.row -->
                    </div>
                    <!-- /.container-fluid -->
                  </section>
                  <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->
        <%- await include('../../_partials/_admin/footer.ejs'); %>

          <!-- Control Sidebar -->
          <aside class="control-sidebar control-sidebar-dark">
            <!-- Control sidebar content goes here -->
          </aside>
          <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->


  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables  & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="../../plugins/jszip/jszip.min.js"></script>
  <script src="../../plugins/pdfmake/pdfmake.min.js"></script>
  <script src="../../plugins/pdfmake/vfs_fonts.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="../../dist/js/demo.js"></script>
  <!-----Datamoment------->
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
  <script src="//cdn.datatables.net/plug-ins/1.10.12/sorting/datetime-moment.js"></script>
  <script src="moment.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.32/moment-timezone.min.js" integrity="sha512-u3yRfU7FD5wGhxEMFZLZT/W/Y+C0vqUuQjPAhRWnQjBZ1LhUMnyTnZ6AfwxLSCxACT4eiyAnjFAMIt0qog67qg==" crossorigin="anonymous"></script>
  <!-------Datamoment------>
  <!-- Page specific script -->
  <script>
    function setOrderStatus(that) {



      
      const swalWithBootstrapButtons = Swal.mixin({
          customClass: {
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-danger'
          },
          buttonsStyling: true
        })

        swalWithBootstrapButtons.fire({
          title: 'Are you sure?',
          text: "You wants to change the status of order!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, update it!',
          cancelButtonText: 'No, cancel!',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {


            var id = $(that).attr('id');
            let data = {
              "status": $(that).val()
            }
            $.ajax({
              url: '/admin/order/update/' + id,
              type: 'post',
              data: data,
            }).done((data) => {
              swalWithBootstrapButtons.fire(
              'Deleted!',
              'status has been updated.',
              'success'
            )
            });
            
          } else if (
            /* Read more about handling dismissals below */
            result.dismiss === Swal.DismissReason.cancel
          ) {
            $('#order').DataTable().ajax.reload()
            /*swalWithBootstrapButtons.fire(
              'Cancelled',
              'Your imaginary file is safe :)',
              'error'
            )*/
          }
        })


      
    }
    function getSelectOptions(value) {
      var options = ['pending','delivered','dispatched','cancelled','refunded','disputed','recieved']
      var selectHtml='<select>';
      
      for(i=0;i< options.length; i++)
      {
        selected = (value==options[i])?'selected':'';  
        selectHtml +=`<option value=${options[i]}  ${selected}>${options[i].toUpperCase()}</option>`
      }

      selectHtml += '</select>';
      return $(selectHtml).html()
   }

   function deleteOrder(that){
     alert($(that).data('url'))
   }

    $(document).ready(function () {
      $.fn.dataTable.moment('HH:mm DD/MM/YYYY');

      $('#order').DataTable({
        "paging": true,
        "processing": true,
        "serverSide": true,
        
        "ordering": false,
        "ajax": {
          "url": "/admin/order/list",
          "type": "get",
        },
        "columns": [
          {
            "data": "shipping.order_id",
            "render": function (data) {
              return data;
            }
          },
          {
            "data": null,
            "render": function (data, type, row) {
              return row._user.first_name +' '+row._user.last_name;
            }
          },
          {
            "data": null,
            "render": function (data, type, row) {
              return row.shipping.address.address1 +', '+row.shipping.address.zipcode+', '+row.shipping.address.emirate;
            }
          },
          {
            "data": "_store.name",
            "render": function (data) {
              return data;
            }
          },
          {
            "data": "createdAt",
            "render": function (data) {
              return (moment(data).isValid()) ? moment(data).format("YYYY-MM-DD  hh:mm:ss a ") : "-";
            }
          },          
          /*{
            "data": "updatedAt",
            "render": function (data) {
              return (moment(data).isValid()) ? moment(data).format("YYYY-MM-DD  hh:mm:ss a ") : "-";
            }
          },*/
          {
            "data": 'shipping.tracking.status',
            "render": function (data, type, row) {
              return '<select class="form-control" name="status " onchange="setOrderStatus(this)" id="'+row._id+'">'+
                getSelectOptions(row.shipping.tracking.status) + '</select>';
            }
          },
          /*{
            "data": 'payement.method',
            "render": function (data) {
              return 'COD';
            }
          },*/
          {
            "data": 'total_cost.$numberDecimal',
            "render": function (data) {
              return parseFloat(data).toFixed(2);
            }
          },
          {
            "data": 'feedback.rating',
            "render": function (data) {
              return data;
            }
          },
          /*{
            "data": 'feedback.comment',
            "render": function (data) {
              return data??'--';
            }
          },*/
          {
            "data": null,
            "render": function (data, type, row) {
              return `<a href="javascript:void(0);"><i class="fas fa-pencil-alt"></i></a>&nbsp &nbsp<a onclick=deleteOrder(this) data-url="http://localhost:4800/admin/order/delete/${row._id}" href="javascript:void(0);"><i class="far fa-trash-alt"></i></a>`;
            }
          }
        ],
        success: function (done) {
         // console.log("--ab", done)
        }
      });
    });

  </script>
</body>

</html>